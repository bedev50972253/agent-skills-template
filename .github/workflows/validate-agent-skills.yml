name: Validate Agent Skills Structure

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    name: agent-skills/validate-structure
    
    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
      
      - name: ğŸ“‹ æª¢æŸ¥ AGENTS.md
        run: |
          echo "æª¢æŸ¥ AGENTS.md æª”æ¡ˆ..."
          if [ ! -f "AGENTS.md" ]; then
            echo "âŒ ç¼ºå°‘ AGENTS.md æª”æ¡ˆ"
            echo "è«‹å¾æ¨¡æ¿è¤‡è£½: https://github.com/bedev50972253/agent-skills-template/blob/master/AGENTS.md"
            exit 1
          fi
          
          # æª¢æŸ¥æª”æ¡ˆå¤§å°ï¼ˆè‡³å°‘ 500 bytesï¼‰
          file_size=$(stat -f%z "AGENTS.md" 2>/dev/null || stat -c%s "AGENTS.md")
          if [ $file_size -lt 500 ]; then
            echo "âš ï¸  AGENTS.md å…§å®¹ä¼¼ä¹ä¸å®Œæ•´ï¼ˆå°æ–¼ 500 bytesï¼‰"
            exit 1
          fi
          
          echo "âœ… AGENTS.md å­˜åœ¨ä¸”æ ¼å¼æ­£ç¢º"
      
      - name: ğŸ¤– æª¢æŸ¥ .github/agents/ ç›®éŒ„
        run: |
          echo "æª¢æŸ¥ Agent å®šç¾©æª”æ¡ˆ..."
          if [ ! -d ".github/agents" ]; then
            echo "âŒ ç¼ºå°‘ .github/agents/ ç›®éŒ„"
            echo "è«‹å»ºç«‹è‡³å°‘ä¸€å€‹ .agent.md æª”æ¡ˆ"
            exit 1
          fi
          
          # è¨ˆç®— agent æª”æ¡ˆæ•¸é‡
          agent_count=$(find .github/agents -name "*.agent.md" | wc -l)
          if [ $agent_count -eq 0 ]; then
            echo "âŒ .github/agents/ ç›®éŒ„ä¸­æ²’æœ‰æ‰¾åˆ° .agent.md æª”æ¡ˆ"
            echo "è«‹è‡³å°‘å»ºç«‹ä¸€å€‹ agent å®šç¾©æª”æ¡ˆ"
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ° $agent_count å€‹ Agent å®šç¾©"
          
          # åˆ—å‡ºæ‰€æœ‰ agents
          echo "ğŸ“ Agent æ¸…å–®:"
          find .github/agents -name "*.agent.md" -exec basename {} \;
      
      - name: ğŸ› ï¸ æª¢æŸ¥ skills/ ç›®éŒ„
        run: |
          echo "æª¢æŸ¥ Skills ç›®éŒ„..."
          if [ ! -d "skills" ]; then
            echo "âŒ ç¼ºå°‘ skills/ ç›®éŒ„"
            echo "è«‹å»ºç«‹è‡³å°‘ä¸€å€‹æŠ€èƒ½è³‡æ–™å¤¾ä¸¦åŒ…å« SKILL.md"
            exit 1
          fi
          
          # è¨ˆç®—æŠ€èƒ½æ•¸é‡
          skill_count=$(find skills -name "SKILL.md" | wc -l)
          if [ $skill_count -eq 0 ]; then
            echo "âŒ skills/ ç›®éŒ„ä¸­æ²’æœ‰æ‰¾åˆ° SKILL.md æª”æ¡ˆ"
            echo "è«‹è‡³å°‘å»ºç«‹ä¸€å€‹æŠ€èƒ½ï¼ˆåƒè€ƒ template-skillï¼‰"
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ° $skill_count å€‹æŠ€èƒ½"
          
          # åˆ—å‡ºæ‰€æœ‰æŠ€èƒ½
          echo "ğŸ“ Skills æ¸…å–®:"
          find skills -name "SKILL.md" -exec dirname {} \; | xargs -I {} basename {}
      
      - name: ğŸ“¦ å®‰è£ YAML é©—è­‰å·¥å…·
        run: |
          # å®‰è£ yq (YAML è™•ç†å·¥å…·)
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version
      
      - name: âœ… é©—è­‰ SKILL.md YAML Frontmatter
        run: |
          echo "é©—è­‰æ‰€æœ‰ SKILL.md çš„ YAML frontmatter..."
          
          error_count=0
          
          for skill_file in $(find skills -name "SKILL.md"); do
            echo ""
            echo "ğŸ” æª¢æŸ¥: $skill_file"
            
            # æª¢æŸ¥æ˜¯å¦æœ‰ YAML frontmatter
            if ! grep -q "^---$" "$skill_file"; then
              echo "âŒ ç¼ºå°‘ YAML frontmatter (æ²’æœ‰æ‰¾åˆ° --- åˆ†éš”ç¬¦)"
              error_count=$((error_count + 1))
              continue
            fi
            
            # æå– YAML frontmatterï¼ˆç¬¬ä¸€å€‹ --- åˆ°ç¬¬äºŒå€‹ ---ï¼‰
            yaml_content=$(sed -n '/^---$/,/^---$/p' "$skill_file" | sed '1d;$d')
            
            if [ -z "$yaml_content" ]; then
              echo "âŒ YAML frontmatter ç‚ºç©º"
              error_count=$((error_count + 1))
              continue
            fi
            
            # é©—è­‰å¿…è¦æ¬„ä½
            required_fields=("name" "description" "version" "category")
            
            for field in "${required_fields[@]}"; do
              if ! echo "$yaml_content" | yq eval ".$field" - | grep -v "null" > /dev/null; then
                echo "âŒ ç¼ºå°‘å¿…è¦æ¬„ä½: $field"
                error_count=$((error_count + 1))
              fi
            done
            
            # æå–ä¸¦é¡¯ç¤º skill è³‡è¨Š
            skill_name=$(echo "$yaml_content" | yq eval '.name' -)
            skill_version=$(echo "$yaml_content" | yq eval '.version' -)
            skill_category=$(echo "$yaml_content" | yq eval '.category' -)
            
            echo "âœ… $skill_name (v$skill_version) - $skill_category"
          done
          
          if [ $error_count -gt 0 ]; then
            echo ""
            echo "âŒ ç™¼ç¾ $error_count å€‹é©—è­‰éŒ¯èª¤"
            exit 1
          fi
          
          echo ""
          echo "âœ… æ‰€æœ‰ SKILL.md YAML æ ¼å¼æ­£ç¢º"
      
      - name: ğŸ“ æª¢æŸ¥ç›®éŒ„çµæ§‹å®Œæ•´æ€§
        run: |
          echo "æª¢æŸ¥å®Œæ•´ç›®éŒ„çµæ§‹..."
          
          # å»ºè­°çš„ç›®éŒ„çµæ§‹
          suggested_dirs=(
            ".github/agents"
            ".github/prompts"
            ".github/instructions"
            "skills"
          )
          
          missing_count=0
          
          for dir in "${suggested_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "âš ï¸  å»ºè­°å»ºç«‹ç›®éŒ„: $dir"
              missing_count=$((missing_count + 1))
            else
              echo "âœ… $dir"
            fi
          done
          
          if [ $missing_count -gt 0 ]; then
            echo ""
            echo "âš ï¸  æœ‰ $missing_count å€‹å»ºè­°ç›®éŒ„ç¼ºå¤±ï¼ˆéå¿…è¦ï¼Œä½†å»ºè­°å»ºç«‹ï¼‰"
          fi
      
      - name: ğŸ“Š ç”Ÿæˆé©—è­‰å ±å‘Š
        if: always()
        run: |
          echo ""
          echo "======================================"
          echo "ğŸ“Š Agent Skills çµæ§‹é©—è­‰å ±å‘Š"
          echo "======================================"
          echo ""
          echo "âœ… æ ¸å¿ƒæª”æ¡ˆ:"
          [ -f "AGENTS.md" ] && echo "  âœ“ AGENTS.md" || echo "  âœ— AGENTS.md"
          [ -f "README.md" ] && echo "  âœ“ README.md" || echo "  â—‹ README.md (é¸ç”¨)"
          echo ""
          echo "âœ… Agent å®šç¾©:"
          agent_count=$(find .github/agents -name "*.agent.md" 2>/dev/null | wc -l)
          echo "  æ‰¾åˆ° $agent_count å€‹ Agent"
          echo ""
          echo "âœ… Skills:"
          skill_count=$(find skills -name "SKILL.md" 2>/dev/null | wc -l)
          echo "  æ‰¾åˆ° $skill_count å€‹æŠ€èƒ½"
          echo ""
          echo "======================================"
      
      - name: ğŸ‰ é©—è­‰å®Œæˆ
        run: |
          echo ""
          echo "ğŸ‰ Agent Skills çµæ§‹é©—è­‰é€šéï¼"
          echo ""
          echo "æ‚¨çš„å°ˆæ¡ˆç¬¦åˆ agentskills.io é–‹æ”¾æ¨™æº–"
          echo "å¯èˆ‡ GitHub Copilotã€Claude Desktopã€Azure AI Foundry æ•´åˆä½¿ç”¨"
          echo ""
