name: åŒæ­¥ Agent Skills

on:
  schedule:
    # æ¯é€±æ—¥ 00:00 UTC è‡ªå‹•æª¢æŸ¥æ¨¡æ¿æ›´æ–°
    - cron: '0 0 * * 0'
  workflow_dispatch:
    # å…è¨±æ‰‹å‹•è§¸ç™¼
  
env:
  TEMPLATE_REPO: bedev50972253/agent-skills-template

jobs:
  sync:
    runs-on: ubuntu-latest
    name: åŒæ­¥ Agent Skills æ¨¡æ¿
    
    steps:
      - name: Checkout ç•¶å‰å€‰åº«
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: è¨­å®š Git ä½¿ç”¨è€…
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: ä¸‹è¼‰æœ€æ–°æ¨¡æ¿
        run: |
          echo "ğŸ“¥ ä¸‹è¼‰æ¨¡æ¿å€‰åº«: $TEMPLATE_REPO"
          git clone --depth 1 https://github.com/$TEMPLATE_REPO /tmp/agent-skills-template
      
      - name: æª¢æŸ¥æª”æ¡ˆè®Šæ›´
        id: check-changes
        run: |
          # æ¯”è¼ƒ AGENTS.md
          if ! diff -q AGENTS.md /tmp/agent-skills-template/AGENTS.md > /dev/null 2>&1; then
            echo "agents_md_changed=true" >> $GITHUB_OUTPUT
          fi
          
          # æ¯”è¼ƒ .github/agents/
          if ! diff -qr .github/agents /tmp/agent-skills-template/.github/agents > /dev/null 2>&1; then
            echo "agents_dir_changed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: æ›´æ–° Agent å®šç¾©æª”æ¡ˆ
        if: steps.check-changes.outputs.agents_md_changed == 'true' || steps.check-changes.outputs.agents_dir_changed == 'true'
        run: |
          echo "ğŸ“ æ›´æ–° Agent å®šç¾©æª”æ¡ˆ..."
          
          # å‚™ä»½ç¾æœ‰è‡ªè¨‚æŠ€èƒ½
          if [ -d "skills/custom" ]; then
            cp -r skills/custom /tmp/backup-custom-skills
          fi
          
          # æ›´æ–°æ ¸å¿ƒæª”æ¡ˆï¼ˆä¸è¦†è“‹è‡ªè¨‚å…§å®¹ï¼‰
          if [ "${{ steps.check-changes.outputs.agents_md_changed }}" == "true" ]; then
            cp /tmp/agent-skills-template/AGENTS.md AGENTS.md
            echo "âœ… å·²æ›´æ–° AGENTS.md"
          fi
          
          # æ›´æ–° Agent å®šç¾©
          if [ "${{ steps.check-changes.outputs.agents_dir_changed }}" == "true" ]; then
            # åƒ…æ›´æ–°æ¨™æº– Agent,ä¿ç•™è‡ªè¨‚ Agent
            for agent in planner backend frontend database infra security; do
              if [ -f "/tmp/agent-skills-template/.github/agents/$agent.agent.md" ]; then
                cp "/tmp/agent-skills-template/.github/agents/$agent.agent.md" ".github/agents/$agent.agent.md"
                echo "âœ… å·²æ›´æ–° $agent.agent.md"
              fi
            done
          fi
          
          # é‚„åŸè‡ªè¨‚æŠ€èƒ½
          if [ -d "/tmp/backup-custom-skills" ]; then
            cp -r /tmp/backup-custom-skills skills/custom
          fi
      
      - name: å»ºç«‹ Pull Request
        if: steps.check-changes.outputs.agents_md_changed == 'true' || steps.check-changes.outputs.agents_dir_changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: åŒæ­¥ Agent Skills æ¨¡æ¿æ›´æ–°"
          title: "ğŸ¤– è‡ªå‹•åŒæ­¥: Agent Skills æ¨¡æ¿æ›´æ–°"
          body: |
            ## ğŸ“‹ è®Šæ›´æ‘˜è¦
            
            æ­¤ PR ç”± GitHub Actions è‡ªå‹•å»ºç«‹,ç”¨æ–¼åŒæ­¥æœ€æ–°çš„ Agent Skills æ¨¡æ¿çµæ§‹ã€‚
            
            **è®Šæ›´ä¾†æº**: [${{ env.TEMPLATE_REPO }}](https://github.com/${{ env.TEMPLATE_REPO }})
            
            ### è®Šæ›´å…§å®¹
            
            - [ ] AGENTS.md æ›´æ–°
            - [ ] Agent å®šç¾©æª”æ¡ˆæ›´æ–° (.github/agents/)
            - [ ] è‡ªè¨‚æŠ€èƒ½å·²ä¿ç•™
            
            ### æª¢æŸ¥æ¸…å–®
            
            - [ ] æª¢è¦–è®Šæ›´å…§å®¹
            - [ ] ç¢ºèªè‡ªè¨‚æŠ€èƒ½æœªè¢«è¦†è“‹
            - [ ] æ¸¬è©¦ Agent åŠŸèƒ½æ­£å¸¸
            - [ ] åˆä½µæ­¤ PR
            
            ---
            
            ğŸ¤– **è‡ªå‹•åŒ–å·¥ä½œæµç¨‹**: `.github/workflows/sync-agent-skills.yml`
          branch: sync-agent-skills
          delete-branch: true
          labels: |
            automation
            agent-skills
            dependencies
      
      - name: å®Œæˆ
        run: |
          echo "âœ… Agent Skills åŒæ­¥å®Œæˆ!"
          echo "ğŸ“ å¦‚æœ‰è®Šæ›´,å·²å»ºç«‹ Pull Request ä¾›å¯©æŸ¥"
