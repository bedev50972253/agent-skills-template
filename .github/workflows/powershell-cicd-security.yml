name: ðŸ“œ PowerShell è…³æœ¬ CI/CD

# ðŸ“Œ é©ç”¨å°ˆæ¡ˆï¼š
# - agent-skills-template (PowerShell å·¥å…·)
# - æ‰€æœ‰åŒ…å« .ps1 è…³æœ¬çš„å°ˆæ¡ˆ

on:
  push:
    branches: [main, master, develop]
    paths:
      - '**.ps1'
      - '**.psm1'
      - '**.psd1'
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # ==============================================
  # 1ï¸âƒ£ PowerShell èªžæ³•é©—è­‰
  # ==============================================
  syntax-check:
    name: ðŸ” PowerShell èªžæ³•æª¢æŸ¥
    runs-on: windows-latest

    steps:
      - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ” æª¢æŸ¥èªžæ³•éŒ¯èª¤
        shell: pwsh
        run: |
          Write-Host "## ðŸ” PowerShell èªžæ³•æª¢æŸ¥" -ForegroundColor Cyan

          $scripts = Get-ChildItem -Path . -Include *.ps1,*.psm1 -Recurse
          $errorCount = 0

          foreach ($script in $scripts) {
            Write-Host "æª¢æŸ¥: $($script.FullName)" -ForegroundColor Yellow

            $errors = $null
            $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content $script.FullName -Raw), [ref]$errors)

            if ($errors.Count -gt 0) {
              Write-Host "âŒ ç™¼ç¾èªžæ³•éŒ¯èª¤:" -ForegroundColor Red
              $errors | ForEach-Object { Write-Host $_ }
              $errorCount++
            } else {
              Write-Host "âœ… é€šéŽ" -ForegroundColor Green
            }
          }

          if ($errorCount -gt 0) {
            Write-Host "âŒ ç¸½è¨ˆ $errorCount å€‹æª”æ¡ˆæœ‰èªžæ³•éŒ¯èª¤" -ForegroundColor Red
            exit 1
          } else {
            Write-Host "âœ… æ‰€æœ‰è…³æœ¬èªžæ³•æ­£ç¢º" -ForegroundColor Green
          }

  # ==============================================
  # 2ï¸âƒ£ PSScriptAnalyzer éœæ…‹åˆ†æž
  # ==============================================
  script-analyzer:
    name: ðŸ”¬ PSScriptAnalyzer åˆ†æž
    runs-on: windows-latest

    steps:
      - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ“¦ å®‰è£ PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: ðŸ” åŸ·è¡Œéœæ…‹åˆ†æž
        shell: pwsh
        run: |
          Write-Host "## ðŸ”¬ PSScriptAnalyzer åˆ†æž" -ForegroundColor Cyan

          $scripts = Get-ChildItem -Path . -Include *.ps1,*.psm1 -Recurse
          $allIssues = @()

          foreach ($script in $scripts) {
            Write-Host "`næª¢æŸ¥: $($script.FullName)" -ForegroundColor Yellow

            $results = Invoke-ScriptAnalyzer -Path $script.FullName -Severity Error,Warning

            if ($results) {
              $allIssues += $results
              $results | Format-Table -AutoSize
            } else {
              Write-Host "âœ… ç„¡å•é¡Œ" -ForegroundColor Green
            }
          }

          # ç”¢ç”Ÿæ‘˜è¦
          Write-Host "`n## ðŸ“Š åˆ†æžæ‘˜è¦" -ForegroundColor Cyan
          Write-Host "ç¸½å•é¡Œæ•¸: $($allIssues.Count)"

          $errorCount = ($allIssues | Where-Object Severity -eq 'Error').Count
          $warningCount = ($allIssues | Where-Object Severity -eq 'Warning').Count

          Write-Host "éŒ¯èª¤: $errorCount" -ForegroundColor Red
          Write-Host "è­¦å‘Š: $warningCount" -ForegroundColor Yellow

          # åŒ¯å‡ºçµæžœ
          if ($allIssues.Count -gt 0) {
            $allIssues | Export-Csv -Path "analyzer-results.csv" -NoTypeInformation
          }

          # å¦‚æžœæœ‰éŒ¯èª¤ï¼Œå¤±æ•—
          if ($errorCount -gt 0) {
            Write-Host "âŒ ç™¼ç¾ $errorCount å€‹éŒ¯èª¤" -ForegroundColor Red
            exit 1
          }

      - name: ðŸ“¤ ä¸Šå‚³åˆ†æžçµæžœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analyzer-results
          path: analyzer-results.csv
        continue-on-error: true

  # ==============================================
  # 3ï¸âƒ£ Pester å–®å…ƒæ¸¬è©¦
  # ==============================================
  pester-tests:
    name: ðŸ§ª Pester å–®å…ƒæ¸¬è©¦
    runs-on: windows-latest

    steps:
      - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ“¦ å®‰è£ Pester
        shell: pwsh
        run: |
          Install-Module -Name Pester -Force -Scope CurrentUser -SkipPublisherCheck

      - name: ðŸ§ª åŸ·è¡Œæ¸¬è©¦
        shell: pwsh
        run: |
          # å°‹æ‰¾æ¸¬è©¦æª”æ¡ˆ
          $testFiles = Get-ChildItem -Path . -Include *.Tests.ps1 -Recurse

          if ($testFiles.Count -eq 0) {
            Write-Host "âš ï¸ æœªæ‰¾åˆ°æ¸¬è©¦æª”æ¡ˆ (*.Tests.ps1)" -ForegroundColor Yellow
            Write-Host "å»ºè­°å»ºç«‹ Pester æ¸¬è©¦ä»¥ç¢ºä¿è…³æœ¬å“è³ª"
            exit 0
          }

          Write-Host "æ‰¾åˆ° $($testFiles.Count) å€‹æ¸¬è©¦æª”æ¡ˆ" -ForegroundColor Cyan

          # åŸ·è¡Œæ¸¬è©¦
          $config = New-PesterConfiguration
          $config.Run.Path = $testFiles
          $config.Output.Verbosity = 'Detailed'
          $config.CodeCoverage.Enabled = $true
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = 'testResults.xml'

          $results = Invoke-Pester -Configuration $config

          if ($results.FailedCount -gt 0) {
            Write-Host "âŒ æ¸¬è©¦å¤±æ•—: $($results.FailedCount) å€‹" -ForegroundColor Red
            exit 1
          }

      - name: ðŸ“Š ä¸Šå‚³æ¸¬è©¦çµæžœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pester-results
          path: testResults.xml
        continue-on-error: true

  # ==============================================
  # 4ï¸âƒ£ å®‰å…¨æª¢æŸ¥ (æ©Ÿå¯†è³‡è¨Š)
  # ==============================================
  security-scan:
    name: ðŸ” PowerShell å®‰å…¨æŽƒæ
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ•µï¸ Gitleaks æŽƒæ
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ” æª¢æŸ¥ç¡¬ç·¨ç¢¼å¯†ç¢¼
        shell: bash
        run: |
          echo "æª¢æŸ¥ PowerShell è…³æœ¬ä¸­çš„æ½›åœ¨å®‰å…¨å•é¡Œ..."

          # æª¢æŸ¥æ˜Žæ–‡å¯†ç¢¼
          if grep -r "password\s*=\s*['\"]" --include="*.ps1" .; then
            echo "âŒ ç™¼ç¾ç¡¬ç·¨ç¢¼å¯†ç¢¼"
            exit 1
          fi

          # æª¢æŸ¥æ˜Žæ–‡ API é‡‘é‘°
          if grep -r "apikey\s*=\s*['\"][^$]" --include="*.ps1" .; then
            echo "âŒ ç™¼ç¾ç¡¬ç·¨ç¢¼ API é‡‘é‘°"
            exit 1
          fi

          echo "âœ… æœªç™¼ç¾æ˜Žé¡¯çš„ç¡¬ç·¨ç¢¼æ©Ÿå¯†"

      - name: ðŸ”’ æª¢æŸ¥å±éšªå‘½ä»¤
        shell: bash
        run: |
          echo "æª¢æŸ¥å±éšªçš„ PowerShell å‘½ä»¤..."

          # æª¢æŸ¥ Invoke-Expression (å¯èƒ½çš„ç¨‹å¼ç¢¼æ³¨å…¥)
          if grep -r "Invoke-Expression\|iex\s" --include="*.ps1" .; then
            echo "âš ï¸ è­¦å‘Šï¼šç™¼ç¾ Invoke-Expressionï¼Œå¯èƒ½æœ‰ç¨‹å¼ç¢¼æ³¨å…¥é¢¨éšª"
          fi

          # æª¢æŸ¥ -Credential åƒæ•¸ä½¿ç”¨
          if grep -r "\-Credential\s\+[^(]" --include="*.ps1" .; then
            echo "âš ï¸ å»ºè­°ä½¿ç”¨ Get-Credential æˆ– SecureString"
          fi

  # ==============================================
  # 5ï¸âƒ£ è·¨å¹³å°æ¸¬è©¦
  # ==============================================
  cross-platform:
    name: ðŸŒ è·¨å¹³å°é©—è­‰
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]

    steps:
      - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ” PowerShell ç‰ˆæœ¬
        shell: pwsh
        run: |
          Write-Host "PowerShell ç‰ˆæœ¬: $($PSVersionTable.PSVersion)"
          Write-Host "ä½œæ¥­ç³»çµ±: $($PSVersionTable.OS)"

      - name: ðŸ§ª åŸºæœ¬åŸ·è¡Œæ¸¬è©¦
        shell: pwsh
        run: |
          $scripts = Get-ChildItem -Path . -Include *.ps1 -Recurse |
                     Where-Object { $_.Name -notmatch '\.Tests\.ps1$' }

          foreach ($script in $scripts) {
            Write-Host "æ¸¬è©¦è¼‰å…¥: $($script.Name)"

            # å˜—è©¦é»žè¼‰å…¥ (ä¸åŸ·è¡Œ)
            try {
              $null = Get-Command -Syntax $script.FullName -ErrorAction Stop
              Write-Host "âœ… $($script.Name)" -ForegroundColor Green
            } catch {
              Write-Host "âš ï¸ $($script.Name) ç„¡æ³•è¼‰å…¥" -ForegroundColor Yellow
            }
          }

  # ==============================================
  # 6ï¸âƒ£ PowerShell æ¨¡çµ„ç™¼å¸ƒ (å¦‚æžœæ˜¯æ¨¡çµ„å°ˆæ¡ˆ)
  # ==============================================
  publish-module:
    name: ðŸ“¦ PowerShell æ¨¡çµ„ç™¼å¸ƒ
    runs-on: windows-latest
    if: github.ref == 'refs/heads/main' && hashFiles('**/*.psd1') != ''
    needs: [syntax-check, script-analyzer, pester-tests]

    steps:
      - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ” é©—è­‰æ¨¡çµ„è³‡è¨Š
        shell: pwsh
        run: |
          $manifest = Get-ChildItem -Path . -Include *.psd1 -Recurse | Select-Object -First 1

          if ($manifest) {
            Write-Host "æ‰¾åˆ°æ¨¡çµ„è³‡è¨Š: $($manifest.FullName)"

            $moduleInfo = Test-ModuleManifest -Path $manifest.FullName
            Write-Host "æ¨¡çµ„åç¨±: $($moduleInfo.Name)"
            Write-Host "ç‰ˆæœ¬: $($moduleInfo.Version)"
            Write-Host "ä½œè€…: $($moduleInfo.Author)"
          }

      - name: ðŸ“¤ ç™¼å¸ƒè‡³ PowerShell Gallery (æ‰‹å‹•è§¸ç™¼)
        if: github.event_name == 'workflow_dispatch'
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          if ($env:PSGALLERY_API_KEY) {
            Write-Host "æº–å‚™ç™¼å¸ƒè‡³ PowerShell Gallery..."
            # Publish-Module -Path . -NuGetApiKey $env:PSGALLERY_API_KEY
            Write-Host "âš ï¸ å–æ¶ˆè¨»è§£ä¸Šæ–¹å‘½ä»¤ä»¥å•Ÿç”¨ç™¼å¸ƒ"
          } else {
            Write-Host "âš ï¸ ç¼ºå°‘ PSGallery API é‡‘é‘°ï¼Œè·³éŽç™¼å¸ƒ"
          }

  # ==============================================
  # 7ï¸âƒ£ PowerShell å®‰å…¨æ‘˜è¦
  # ==============================================
  powershell-summary:
    name: ðŸ“Š PowerShell å®‰å…¨æ‘˜è¦
    runs-on: ubuntu-latest
    if: always()
    needs: [syntax-check, script-analyzer, security-scan]

    steps:
      - name: ðŸ“‹ ç”¢ç”Ÿæ‘˜è¦å ±å‘Š
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸ“œ PowerShell è…³æœ¬æŽƒææ‘˜è¦

          ## âœ… å®Œæˆçš„æª¢æŸ¥é …ç›®
          - âœ“ PowerShell èªžæ³•é©—è­‰
          - âœ“ PSScriptAnalyzer éœæ…‹åˆ†æž
          - âœ“ Pester å–®å…ƒæ¸¬è©¦
          - âœ“ æ©Ÿå¯†è³‡è¨ŠæŽƒæ
          - âœ“ å±éšªå‘½ä»¤æª¢æŸ¥
          - âœ“ è·¨å¹³å°ç›¸å®¹æ€§æ¸¬è©¦

          ## ðŸŽ¯ PowerShell æœ€ä½³å¯¦è¸
          1. ä½¿ç”¨ `[CmdletBinding()]` å•Ÿç”¨é€²éšŽå‡½å¼åŠŸèƒ½
          2. å¯¦ä½œé©ç•¶çš„éŒ¯èª¤è™•ç† (`try/catch`)
          3. ä½¿ç”¨ `SecureString` è™•ç†æ•æ„Ÿè³‡è¨Š
          4. é¿å… `Invoke-Expression`ï¼Œæ”¹ç”¨ `& $Command`
          5. åŠ å…¥ Pester æ¸¬è©¦ç¢ºä¿è…³æœ¬å“è³ª
          6. ä½¿ç”¨ `Get-Credential` è€Œéžç¡¬ç·¨ç¢¼å¯†ç¢¼
          7. å•Ÿç”¨ `-WhatIf` å’Œ `-Confirm` æ”¯æ´

          ## ðŸ“š åƒè€ƒè³‡æº
          - [PowerShell æœ€ä½³å¯¦è¸](https://github.com/PoshCode/PowerShellPracticeAndStyle)
          - [PSScriptAnalyzerè¦å‰‡](https://github.com/PowerShell/PSScriptAnalyzer)
          - [Pester æ¸¬è©¦æ¡†æž¶](https://pester.dev/)

          ---
          ðŸ¤– ç”± GitHub Actions è‡ªå‹•ç”¢ç”Ÿ
          EOF
